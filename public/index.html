<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Secure Video Upload</title>
<style>
body{
  margin:0;
  font-family: 'Segoe UI', sans-serif;
  background: linear-gradient(135deg,#1e3c72,#2a5298);
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
}

.container{
  background: rgba(255,255,255,0.1);
  backdrop-filter: blur(15px);
  padding:40px;
  border-radius:20px;
  width:400px;
  color:white;
  box-shadow:0 20px 40px rgba(0,0,0,0.4);
}

h2{
  text-align:center;
  margin-bottom:30px;
}

input,button{
  width:100%;
  padding:12px;
  margin-bottom:15px;
  border:none;
  border-radius:8px;
  font-size:14px;
}

input{
  background:rgba(255,255,255,0.2);
  color:white;
}

button{
  background:#00c6ff;
  color:black;
  font-weight:bold;
  cursor:pointer;
  transition:0.3s;
}

button:hover{
  background:#00e0ff;
}

.progress-box{
  display:none;
}

.progress-bar{
  height:12px;
  background:#444;
  border-radius:10px;
  overflow:hidden;
  margin-top:10px;
}

.progress{
  height:100%;
  width:0%;
  background:linear-gradient(90deg,#00ffcc,#00c6ff);
  transition:0.2s;
}

.stats{
  font-size:13px;
  margin-top:8px;
  display:flex;
  justify-content:space-between;
}

.success{
  margin-top:20px;
  background:rgba(0,255,0,0.2);
  padding:10px;
  border-radius:8px;
  text-align:center;
}
a{
  color:#00ffcc;
}
</style>
</head>
<body>

<div class="container">
  <h2>Upload Secure Video</h2>

  <input type="file" id="videoFile">
  <input type="number" id="expiry" placeholder="Expiry in Minutes">
  <button id="uploadBtn" onclick="uploadVideo()">Upload Video</button>

  <div class="progress-box" id="progressBox">
    <div class="progress-bar">
      <div class="progress" id="progress"></div>
    </div>
    <div class="stats">
      <span id="percent">0%</span>
      <span id="size">0 MB</span>
    </div>
  </div>

  <div id="result"></div>
</div>

<script>
async function uploadVideo(){
  const file = document.getElementById("videoFile").files[0];
  const expiry = document.getElementById("expiry").value;
  const btn = document.getElementById("uploadBtn");

  if(!file || !expiry){
    alert("Select file and expiry time");
    return;
  }

  btn.disabled = true;
  btn.innerText = "Preparing Upload...";
  document.getElementById("progressBox").style.display="block";

  const res = await fetch("/.netlify/functions/upload",{
    method:"POST",
    body:JSON.stringify({
      filename:file.name,
      expiryMinutes:expiry
    })
  });

  const data = await res.json();

  const xhr = new XMLHttpRequest();
  xhr.open("PUT", data.uploadUrl, true);
  xhr.setRequestHeader("Content-Type", file.type);

  const startTime = Date.now();

  xhr.upload.onprogress = function(e){
    if(e.lengthComputable){
      const percent = (e.loaded / e.total) * 100;
      document.getElementById("progress").style.width = percent+"%";
      document.getElementById("percent").innerText = percent.toFixed(1)+"%";

      const uploadedMB = (e.loaded/1024/1024).toFixed(2);
      const totalMB = (e.total/1024/1024).toFixed(2);

      const elapsed = (Date.now()-startTime)/1000;
      const speed = e.loaded/elapsed;
      const remainingBytes = e.total - e.loaded;
      const remainingSec = remainingBytes/speed;

      document.getElementById("size").innerText =
        uploadedMB+"MB / "+totalMB+"MB | "+remainingSec.toFixed(1)+"s left";
    }
  };

  xhr.onload = function(){
    btn.innerText = "Upload Complete";
    document.getElementById("result").innerHTML =
      `<div class="success">
        Video Uploaded! <br><br>
        <a href="player.html?id=${data.id}" target="_blank">
          Open Secure Player
        </a>
      </div>`;
  };

  xhr.send(file);
}
</script>

</body>
</html>
